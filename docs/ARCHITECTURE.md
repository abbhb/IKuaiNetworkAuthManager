# Network Manager 架构图

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                        用户浏览器                             │
│                    http://localhost:8000                     │
└────────────────────────┬────────────────────────────────────┘
                         │
                         │ HTTP Request
                         ▼
┌─────────────────────────────────────────────────────────────┐
│                   Django 应用服务器                           │
│  ┌─────────────────────────────────────────────────────┐   │
│  │  LoginRequiredMiddleware (登录拦截)                  │   │
│  └───────────────────┬─────────────────────────────────┘   │
│                      │                                       │
│  ┌──────────────────▼──────────────────────────────────┐   │
│  │          Django Auth / LDAP Auth                     │   │
│  │     ┌──────────────┐  ┌─────────────────┐          │   │
│  │     │ Django Users │  │ LDAP Server      │          │   │
│  │     └──────────────┘  └─────────────────┘          │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                              │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              URL Router                              │   │
│  │   /admin/    /accounts/login/    /accounts/logout/  │   │
│  └───────────────────┬─────────────────────────────────┘   │
│                      │                                       │
│  ┌──────────────────▼──────────────────────────────────┐   │
│  │                Views & Admin                         │   │
│  │  ┌──────────────┐  ┌────────────────────────────┐  │   │
│  │  │ Admin Pages  │  │  sync_manager Admin        │  │   │
│  │  └──────────────┘  └────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────┘   │
└────────────────┬────────────────────┬──────────────────────┘
                 │                    │
                 │                    │
    ┌────────────▼──────┐   ┌────────▼────────────┐
    │   MySQL 数据库     │   │    Redis 缓存/会话   │
    │                   │   │                     │
    │ ┌───────────────┐ │   │  - Cache            │
    │ │ User          │ │   │  - Session          │
    │ │ ThirdParty    │ │   │  - Celery Broker    │
    │ │ SyncRecord    │ │   └─────────────────────┘
    │ │ DataItem      │ │            │
    │ └───────────────┘ │            │
    └───────────────────┘            │
                                     │
                         ┌───────────▼─────────────┐
                         │   Celery Worker         │
                         │                         │
                         │  ┌──────────────────┐  │
                         │  │ Async Tasks      │  │
                         │  │ - sync_data      │  │
                         │  │ - cleanup        │  │
                         │  └──────────────────┘  │
                         └───────────┬─────────────┘
                                     │
                         ┌───────────▼─────────────┐
                         │   Celery Beat           │
                         │   (定时任务调度器)        │
                         │                         │
                         │  ┌──────────────────┐  │
                         │  │ Periodic Tasks   │  │
                         │  │ - Every 15 min   │  │
                         │  └──────────────────┘  │
                         └─────────────────────────┘
                                     │
                    ┌────────────────▼─────────────────┐
                    │      第三方 API 服务               │
                    │  http://api.example.com          │
                    └──────────────────────────────────┘
```

## 配置加载流程

```
应用启动
    │
    ▼
读取 DJANGO_ENV 环境变量
    │
    ├─► dev  ────► 加载 default.py + dev.py
    ├─► prod ────► 加载 default.py + prod.py
    └─► 其他 ────► 仅加载 default.py
```

## 请求处理流程

```
用户请求
    │
    ▼
┌─────────────────┐
│ 中间件检查认证    │
└────┬───────┬────┘
     │       │
  未认证   已认证
     │       │
     ▼       ▼
 跳转登录  处理请求
     │       │
     ▼       ▼
┌─────────────────┐
│ LDAP/Django Auth│
└────────┬────────┘
         │
      认证成功
         │
         ▼
┌─────────────────┐
│   视图/Admin    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  数据库/缓存    │
└─────────────────┘
```

## 数据同步流程

```
┌─────────────────────────────────────────────────┐
│  Celery Beat (定时调度器)                        │
│  每 15 分钟触发一次                               │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  sync_all_active_systems                        │
│  查询所有活跃的第三方系统                          │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
         为每个系统创建任务
                 │
    ┌────────────┼────────────┐
    │            │            │
    ▼            ▼            ▼
┌─────────┐ ┌─────────┐ ┌─────────┐
│System 1 │ │System 2 │ │System 3 │
└────┬────┘ └────┬────┘ └────┬────┘
     │           │           │
     └───────────┴───────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  sync_third_party_data (异步任务)                │
│                                                 │
│  1. 创建 SyncRecord (processing)                │
│  2. 调用第三方 API                               │
│  3. 解析响应数据                                 │
│  4. 更新/创建 DataItem                          │
│  5. 更新 SyncRecord (success/failed)            │
└────────────────┬────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────┐
│  MySQL 数据库                                    │
│  - 保存同步记录                                  │
│  - 保存/更新数据项                               │
└─────────────────────────────────────────────────┘
```

## 目录结构详解

```
network_manager/
│
├── config/                      # Django 项目配置
│   ├── settings/               # 分层配置目录
│   │   ├── __init__.py        # 配置加载器 (读取 DJANGO_ENV)
│   │   ├── default.py         # 基础配置 (数据库、Redis、Celery、LDAP)
│   │   ├── dev.py             # 开发配置 (DEBUG=True, 详细日志)
│   │   └── prod.py            # 生产配置 (安全设置、日志文件)
│   │
│   ├── celery.py              # Celery 应用配置
│   ├── middleware.py          # 自定义中间件 (LoginRequiredMiddleware)
│   ├── urls.py                # URL 路由配置
│   └── __init__.py            # 加载 Celery 应用
│
├── sync_manager/              # 同步管理应用
│   ├── models.py              # 数据模型
│   │   ├── ThirdPartySystem   # 第三方系统配置
│   │   ├── SyncRecord         # 同步记录
│   │   └── DataItem           # 同步的数据
│   │
│   ├── tasks.py               # Celery 异步任务
│   │   ├── sync_third_party_data      # 同步单个系统
│   │   ├── sync_all_active_systems    # 定期同步所有系统
│   │   └── cleanup_old_sync_records   # 清理旧记录
│   │
│   └── admin.py               # Django Admin 配置
│
├── templates/                 # 模板文件
│   └── registration/
│       └── login.html         # 登录页面
│
├── README.md                  # 完整文档
├── QUICKSTART.md              # 快速开始指南
├── IMPLEMENTATION.md          # 实现细节说明
├── 完成情况.md                # 项目完成情况
├── .env.example               # 环境变量示例
├── start_dev.sh               # Linux/Mac 启动脚本
├── start_dev.bat              # Windows 启动脚本
└── pyproject.toml             # 项目依赖定义
```

## 数据流图

```
┌──────────────┐
│ 第三方 API    │
└──────┬───────┘
       │ HTTP Request
       ▼
┌──────────────────────┐
│ Celery Task          │
│ sync_third_party_data│
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ 创建 SyncRecord      │
│ status: processing   │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ 解析数据并保存        │
│ DataItem.objects     │
│ .update_or_create()  │
└──────┬───────────────┘
       │
       ▼
┌──────────────────────┐
│ 更新 SyncRecord      │
│ status: success      │
│ records_synced: 10   │
└──────────────────────┘
```

## 技术栈层次图

```
┌─────────────────────────────────────────┐
│           应用层 (Application)           │
│  Django Views, Admin, Templates        │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         业务逻辑层 (Business)             │
│  Models, Tasks, Middleware              │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│         框架层 (Framework)               │
│  Django 4.2, Celery 5.3                 │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│        数据存储层 (Storage)               │
│  MySQL 8.0, Redis 6.0                   │
└─────────────────────────────────────────┘
```

## 认证流程图

```
用户访问受保护页面
        │
        ▼
┌────────────────┐
│ 检查是否已认证  │
└────┬──────┬────┘
     │      │
    否      是
     │      │
     ▼      └─────► 允许访问
┌────────────────┐
│ 重定向到登录页  │
└────────┬───────┘
         │
         ▼
┌────────────────┐
│ 用户输入凭据    │
└────────┬───────┘
         │
         ▼
┌────────────────────────┐
│ LDAP 认证 (如果启用)    │
│ └─失败─► Django 认证   │
└────────┬───────────────┘
         │
         ▼
   认证成功
         │
         ▼
┌────────────────┐
│ 重定向到原页面  │
└────────────────┘
```
